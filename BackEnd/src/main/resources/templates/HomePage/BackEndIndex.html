<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>數據分析 - DINEEASE餐廳管理系統</title>

	<!-- Favicon -->
		<link rel="icon" th:href="@{/images/favicon.ico}" />

	<!-- Google Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100..900&display=swap" rel="stylesheet" />

	<!-- Font Awesome -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

	<!-- DataTables -->
		<link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.css" />

	<!-- Custom CSS -->
		<link rel="stylesheet" th:href="@{/css/demo.css}" />

	<!-- JavaScript Libraries -->
		<script th:src="@{/jquery/jquery-3.7.1.js}"></script>
		<script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

	<style>
		/* 主要樣式 */
		.stats-container {
			display: flex;
			justify-content: space-between;
			padding: 20px;
			gap: 20px;
			width: 100%;
			margin: 0 auto;
		}

		.stat-card {
			background: white;
			border-radius: 12px;
			padding: 24px;
			flex: 1;
			min-width: 200px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			border: 1px solid #e0e0e0;
			transition: transform 0.2s;
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		.stat-card:hover {
			transform: translateY(-5px);
		}

		.stat-icon {
			font-size: 2.5rem;
			color: #000000;
			margin-bottom: 15px;
		}

		.stat-info {
			text-align: center;
		}

		.stat-info h3 {
			margin: 0;
			font-size: 1.2rem;
			color: #666;
			font-weight: 500;
		}

		.stat-info p {
			margin: 10px 0 0;
			font-size: 2rem;
			font-weight: bold;
			color: #333;
		}

		/* 圖表容器樣式 */
		.charts-container {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			gap: 20px;
			padding: 20px;
			width: 100%;
			margin: 0 auto;
		}

		.chart-wrapper {
			background: white;
			border-radius: 12px;
			padding: 20px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			border: 1px solid #e0e0e0;
			height: 400px;
			width: 100%;

		}

		.chart-wrapper:last-child {
			grid-column: 1 / -1;
		}
		/* 調整頁面整體布局 */
		#page {
			display: flex;
			min-height: 100vh;
			width: 100%;
		}
		/* 清除可能的多餘邊距 */
		body {
			margin: 0;
			padding: 0;
			background-color: white;
		}

		/* 修改 #right 樣式 */
		#right {
			flex: 1;
			background-color: white;
			width: 100%;
			min-height: 100vh;
			overflow-x: hidden;
		}

		#memberPieChart,
		#revenueChart,
		#topDishesChart {
			width: 100%;
			height: 100%;
		}

		/* 主要區塊樣式 */
		main {
			padding: 20px;
			background-color: white; /* 改為白色背景 */
			min-height: 100%;
			width: 100%;
		}

		/* 響應式設計 */
		@media (max-width: 900px) {
			.stats-container {
				flex-direction: column;
			}

			.charts-container {
				grid-template-columns: 1fr;
			}

			.chart-wrapper {
				height: 300px;
			}
		}
	</style>
</head>

<body>
<div id="page">
	<div th:replace="~{layout/navbar}"></div>
	<div id="right">
		<div th:replace="~{layout/headerlogout.html}"></div>

		<main>
			<!-- 統計卡片區域 -->
			<div class="stats-container">
				<div class="stat-card">
					<div class="stat-icon">
						<i class="fas fa-users"></i>
					</div>
					<div class="stat-info">
						<h3>會員總數</h3>
						<p id="memberCount">0</p>
					</div>
				</div>

				<div class="stat-card">
					<div class="stat-icon">
						<i class="fas fa-dollar-sign"></i>
					</div>
					<div class="stat-info">
						<h3>本月營收</h3>
						<p id="monthlyRevenue">0</p>
					</div>
				</div>

				<div class="stat-card">
					<div class="stat-icon">
						<i class="fas fa-shopping-cart"></i>
					</div>
					<div class="stat-info">
						<h3>本月訂單數</h3>
						<p id="monthlyOrders">0</p>
					</div>
				</div>
			</div>

			<!-- 圖表區域 -->
			<div class="charts-container">
				<div class="chart-wrapper">
					<div id="memberPieChart"></div>
				</div>
				<div class="chart-wrapper">
					<div id="revenueChart"></div>
				</div>
				<div class="chart-wrapper">
					<div id="topDishesChart"></div>
				</div>
			</div>
		</main>
	</div>
</div>

<script>
	document.addEventListener('DOMContentLoaded', function() {
		// 初始化所有圖表
		const memberPieChart = echarts.init(document.getElementById('memberPieChart'));
		const revenueChart = echarts.init(document.getElementById('revenueChart'));
		const topDishesChart = echarts.init(document.getElementById('topDishesChart'));

		// 內用外帶分布圖表配置
		const orderTypeOption = {
			title: {
				text: '內用外帶分布',
				left: 'center'
			},
			tooltip: {
				trigger: 'item',
				formatter: '{b}: {c} ({d}%)'
			},
			legend: {
				orient: 'horizontal',
				bottom: 'bottom'
			},
			color: ['#42a5f5', '#ffa726'], // 修改饼图的颜色：第一个为内用，第二个为外带
			series: [{
				name: '訂單類型',
				type: 'pie',
				radius: '50%',
				data: [], // 後端數據將填充這裡
				emphasis: {
					itemStyle: {
						shadowBlur: 10,
						shadowOffsetX: 0,
						shadowColor: 'rgba(0, 0, 0, 0.5)'
					}
				}
			}]
		};

		// 本月營收趨勢圖表配置
		const revenueOption = {
			title: {
				text: '本月營收趨勢',
				left: 'center'
			},
			tooltip: {
				trigger: 'axis',
				formatter: '{b}<br/>營收：${c}'
			},
			xAxis: {
				type: 'category',
				data: []
			},
			yAxis: {
				type: 'value',
				name: '營收（元）',
				axisLabel: {
					formatter: '${value}'
				}
			},
			series: [{
				name: '營收',
				type: 'line',
				smooth: true,
				data: [],
				itemStyle: {
					color: '#0071e3'
				},
				areaStyle: {
					color: {
						type: 'linear',
						x: 0,
						y: 0,
						x2: 0,
						y2: 1,
						colorStops: [{
							offset: 0,
							color: 'rgba(0,113,227,0.3)'
						}, {
							offset: 1,
							color: 'rgba(0,113,227,0.1)'
						}]
					}
				}
			}]
		};

		// 熱門餐點排行圖表配置
		const topDishesOption = {
			title: {
				text: '本月熱門餐點排行',
				left: 'center'
			},
			tooltip: {
				trigger: 'axis',
				axisPointer: {
					type: 'shadow'
				}
			},
			xAxis: {
				type: 'category',
				data: [],
				axisLabel: {
					interval: 0,
					rotate: 30
				}
			},
			yAxis: {
				type: 'value',
				name: '銷售數量'
			},
			series: [{
				name: '銷售量',
				type: 'bar',
				data: [],
				itemStyle: {
					color: function (params) {
						// 根据分类设置颜色
						const colors = ['#42a5f5', '#66bb6a', '#ffa726', '#ab47bc', '#ef5350'];
						return colors[params.dataIndex % colors.length];
					}
				}
			}]
		};

		// 設置圖表初始配置
		memberPieChart.setOption(orderTypeOption);
		revenueChart.setOption(revenueOption);
		topDishesChart.setOption(topDishesOption);

		// 獲取數據的函數
		async function fetchDashboardData() {
			try {
				console.log('開始獲取數據...');
				const response = await fetch('/api/dashboard');
				const data = await response.json();
				console.log('獲取到的數據:', data);


				// 更新統計卡片
				document.getElementById('memberCount').textContent =
						(data.totalMembers || 0).toLocaleString();

				document.getElementById('monthlyRevenue').textContent =
						`$${(data.monthlyRevenue || 0).toLocaleString()}`;

				document.getElementById('monthlyOrders').textContent =
						(data.monthlyOrders || 0).toLocaleString();

				// 更新內用外帶分布圖
				if (data.orderTypeDistribution && Array.isArray(data.orderTypeDistribution)) {
					memberPieChart.setOption({
						series: [{
							data: data.orderTypeDistribution
						}]
					});
				}

				// 更新營收趨勢圖
				if (data.revenueData && data.revenueData.dates) {
					revenueChart.setOption({
						xAxis: {
							data: data.revenueData.dates || []
						},
						series: [{
							data: data.revenueData.values || []
						}]
					});
				}

				// 更新熱門餐點圖
				if (data.topDishes && data.topDishes.names) {
					const categories = data.topDishes.names;
					const values = data.topDishes.values;

					// 为每个数据点动态设置颜色
					const chartData = categories.map((name, index) => ({
						value: values[index],
						itemStyle: {
							color: ['#42a5f5', '#66bb6a', '#ffa726', '#ab47bc', '#ef5350'][index % 5] // 不同分类颜色
						}
					}));
					topDishesChart.setOption({
						xAxis: {
							data: data.topDishes.names || []
						},
						series: [{
							data: data.topDishes.values || []
						}]
					});
				}
			} catch (error) {
				console.error('獲取儀表板數據失敗:', error);
			}
		}

		// 初始加載數據
		fetchDashboardData();

		// 設置定時更新（每分鐘更新一次）
		setInterval(fetchDashboardData, 30000);

		// 響應式處理
		window.addEventListener('resize', function() {
			memberPieChart.resize();
			revenueChart.resize();
			topDishesChart.resize();
		});
	});
</script>
</body>
</html>